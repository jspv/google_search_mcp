# Containerized MCP Service Dockerfile
FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
  curl \
  && rm -rf /var/lib/apt/lists/*

# Install uv
RUN pip install uv

# Copy requirements and install Python dependencies
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen --extra container --extra http

# Copy source code
COPY server.py .
COPY server_http.py .
COPY server_http_stream.py .

# Expose ports for different MCP modes
EXPOSE 8000 8001 8002

# Default to HTTP streaming mode, but allow override
ENV MCP_MODE=http-stream
ENV HOST=0.0.0.0
ENV PORT=8000

# Create entrypoint script
RUN echo '#!/bin/bash\n\
  case "$MCP_MODE" in\n\
  "stdio")\n\
  echo "Starting MCP server in stdio mode..."\n\
  exec uv run python server.py\n\
  ;;\n\
  "http")\n\
  echo "Starting MCP server in HTTP mode on $HOST:$PORT..."\n\
  exec uv run python server_http.py\n\
  ;;\n\
  "http-stream")\n\
  echo "Starting MCP server in HTTP streaming mode on $HOST:$PORT..."\n\
  exec uv run python server_http_stream.py\n\
  ;;\n\
  *)\n\
  echo "Unknown MCP_MODE: $MCP_MODE. Use stdio, http, or http-stream"\n\
  exit 1\n\
  ;;\n\
  esac' > /app/entrypoint.sh

RUN chmod +x /app/entrypoint.sh

ENTRYPOINT ["/app/entrypoint.sh"]